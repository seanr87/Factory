# Modular study provisioning workflow
# Per briefing/workflows/reusable.md and briefing/security/best-practices.md

name: Provision New Study

on:
  workflow_dispatch:
    inputs:
      study_title:
        description: 'Study title'
        required: true
        type: string
      study_lead_selection:
        description: 'Select existing study lead or add new'
        required: true
        type: choice
        options:
          - 'Dr. Sarah Johnson|sarahj-researcher'
          - 'Prof. Michael Chen|mchen-lab' 
          - 'Dr. Lisa Rodriguez|lrodriguez-phd'
          - 'Add new study lead'
      new_lead_name:
        description: 'New study lead name (only if adding new)'
        required: false
        type: string
      new_lead_github:
        description: 'New study lead GitHub username (only if adding new)'
        required: false
        type: string
      target_date:
        description: 'Target completion date (YYYY-MM-DD)'
        required: true
        type: string

# Per briefing/actions/permissions.md - minimal permissions
permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve study lead information
        id: resolve_lead
        uses: ./.github/actions/manage-study-leads
        with:
          operation: validate
          selected_lead: ${{ inputs.study_lead_selection }}
          lead_name: ${{ inputs.new_lead_name }}
          lead_github: ${{ inputs.new_lead_github }}

      - name: Add new study lead to database
        if: inputs.study_lead_selection == 'Add new study lead'
        uses: ./.github/actions/manage-study-leads
        with:
          operation: add
          lead_name: ${{ inputs.new_lead_name }}
          lead_github: ${{ inputs.new_lead_github }}

      - name: Commit updated study leads data
        if: inputs.study_lead_selection == 'Add new study lead'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/data/study-leads.json
          git diff --staged --quiet || git commit -m "Add new study lead: ${{ inputs.new_lead_name }}"
          git push

      - name: Validate inputs
        id: validate
        uses: ./.github/actions/validate-study-inputs
        with:
          study_title: ${{ inputs.study_title }}
          lead_name: ${{ steps.resolve_lead.outputs.lead_name }}
          lead_github: ${{ steps.resolve_lead.outputs.lead_github }}
          target_date: ${{ inputs.target_date }}

      - name: Create repository
        id: repo
        uses: ./.github/actions/create-study-repository
        with:
          repo_name: ${{ steps.validate.outputs.repo_name }}
          study_title: ${{ inputs.study_title }}
          lead_github: ${{ steps.resolve_lead.outputs.lead_github }}
          org_token: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Setup project
        id: project
        uses: ./.github/actions/setup-study-project
        with:
          repo_name: ${{ steps.validate.outputs.repo_name }}
          study_title: ${{ inputs.study_title }}
          org_token: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Create Factory tracking
        id: tracking
        uses: ./.github/actions/create-factory-tracking
        with:
          study_title: ${{ inputs.study_title }}
          lead_name: ${{ steps.resolve_lead.outputs.lead_name }}
          lead_github: ${{ steps.resolve_lead.outputs.lead_github }}
          target_date: ${{ inputs.target_date }}
          repo_url: ${{ steps.repo.outputs.repo_url }}
          org_token: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Add to Factory project
        uses: ./.github/actions/add-to-factory-project
        with:
          issue_node_id: ${{ steps.tracking.outputs.issue_node_id }}
          study_title: ${{ inputs.study_title }}
          factory_project_number: ${{ vars.FACTORY_PROJECT_NUMBER }}
          org_token: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Summary
        run: |
          echo "## âœ… Study Provisioned Successfully"
          echo ""
          echo "**Repository:** ${{ steps.repo.outputs.repo_url }}"
          echo "**Project:** ${{ steps.project.outputs.project_url }}"
          echo "**Lead:** @${{ steps.resolve_lead.outputs.lead_github }}"
          echo "**Factory Tracking:** ${{ steps.tracking.outputs.issue_url }}"
          echo ""
          echo "### Next Steps:"
          echo "1. Visit the repository and update the README"
          echo "2. Check the linked project board for stage tracking"
          echo "3. Begin Base Camp stage in the project"
          echo "4. Add data partners as needed"
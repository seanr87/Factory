# Modular study provisioning workflow
# Per briefing/workflows/reusable.md and briefing/security/best-practices.md

name: Provision New Study

on:
  workflow_dispatch:
    inputs:
      study_title:
        description: 'Study title'
        required: true
        type: string
      lead_name:
        description: 'Study lead name'
        required: true
        type: string
      lead_github:
        description: 'Study lead GitHub username'
        required: true
        type: string
      target_date:
        description: 'Target completion date (YYYY-MM-DD)'
        required: true
        type: string

# Per briefing/actions/permissions.md - minimal permissions
permissions:
  contents: read
  issues: write
  repository-projects: write

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate inputs
        id: validate
        uses: ./.github/actions/validate-study-inputs
        with:
          study_title: ${{ inputs.study_title }}
          lead_name: ${{ inputs.lead_name }}
          lead_github: ${{ inputs.lead_github }}
          target_date: ${{ inputs.target_date }}

      - name: Create repository
        id: repo
        uses: ./.github/actions/create-study-repository
        with:
          repo_name: ${{ steps.validate.outputs.repo_name }}
          study_title: ${{ inputs.study_title }}
          lead_github: ${{ inputs.lead_github }}
          org_token: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Setup project
        id: project
        uses: ./.github/workflows/reusable/setup-study-project.yml
        with:
          repo_name: ${{ steps.validate.outputs.repo_name }}
          study_title: ${{ inputs.study_title }}
        secrets:
          org_token: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Create Factory tracking
        id: tracking
        uses: ./.github/actions/create-factory-tracking
        with:
          study_title: ${{ inputs.study_title }}
          lead_name: ${{ inputs.lead_name }}
          lead_github: ${{ inputs.lead_github }}
          target_date: ${{ inputs.target_date }}
          repo_url: ${{ steps.repo.outputs.repo_url }}
          org_token: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Add to Factory project
        uses: ./.github/actions/add-to-factory-project
        with:
          issue_node_id: ${{ steps.tracking.outputs.issue_node_id }}
          study_title: ${{ inputs.study_title }}
          org_token: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Summary
        run: |
          echo "## âœ… Study Provisioned Successfully"
          echo ""
          echo "**Repository:** ${{ steps.repo.outputs.repo_url }}"
          echo "**Project:** ${{ steps.project.outputs.project_url }}"
          echo "**Lead:** @${{ inputs.lead_github }}"
          echo "**Factory Tracking:** ${{ steps.tracking.outputs.issue_url }}"
          echo ""
          echo "### Next Steps:"
          echo "1. Visit the repository and update the README"
          echo "2. Check the linked project board for stage tracking"
          echo "3. Begin Base Camp stage in the project"
          echo "4. Add data partners as needed"
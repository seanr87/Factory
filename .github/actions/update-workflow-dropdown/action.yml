name: 'Update Workflow Dropdown'
description: 'Updates the provision-study workflow dropdown with current study leads'
inputs:
  workflow_path:
    description: 'Path to the workflow file to update'
    required: true
    default: '.github/workflows/provision-study.yml'

runs:
  using: 'composite'
  steps:
    - name: Update dropdown options
      shell: bash
      run: |
        echo "üîç Starting workflow dropdown update..."
        
        # Check if study leads file exists
        if [[ ! -f .github/data/study-leads.json ]]; then
          echo "‚ùå No study leads file found, skipping update"
          exit 0
        fi
        
        echo "üìñ Reading study leads from JSON..."
        cat .github/data/study-leads.json
        
        # Count study leads
        LEAD_COUNT=$(jq '.study_leads | length' .github/data/study-leads.json)
        echo "üìä Found $LEAD_COUNT study leads"
        
        if [[ $LEAD_COUNT -eq 0 ]]; then
          echo "‚ö†Ô∏è  No study leads found, keeping only 'Add new study lead' option"
          OPTIONS_CONTENT="          - 'Add new study lead'"
        else
          echo "üîÑ Generating dropdown options..."
          
          # Generate dropdown options from JSON
          OPTIONS_CONTENT=""
          while IFS= read -r line; do
            NAME=$(echo "$line" | jq -r '.name')
            GITHUB=$(echo "$line" | jq -r '.github_username')
            echo "  Processing: $NAME ($GITHUB)"
            
            # Escape single quotes in name for YAML
            ESCAPED_NAME=$(echo "$NAME" | sed "s/'/''/g")
            OPTIONS_CONTENT="${OPTIONS_CONTENT}          - '${ESCAPED_NAME}|${GITHUB}'\n"
          done < <(jq -c '.study_leads[]' .github/data/study-leads.json)
          
          # Add "Add new study lead" option at the end
          OPTIONS_CONTENT="${OPTIONS_CONTENT}          - 'Add new study lead'"
        fi
        
        echo "üìù Generated options:"
        echo -e "$OPTIONS_CONTENT"
        
        # Update workflow using sed - more YAML-safe approach
        echo "üîß Updating workflow file..."
        
        # Create temporary file with new options
        echo -e "$OPTIONS_CONTENT" > /tmp/new_options.txt
        
        # Find start and end line numbers for the options section
        START_LINE=$(grep -n "        options:" "${{ inputs.workflow_path }}" | cut -d: -f1)
        END_LINE=$(awk "/^        options:/{flag=1; next} flag && /^      [a-zA-Z]/{print NR-1; exit}' "${{ inputs.workflow_path }}")
        
        if [[ -n "$START_LINE" ]] && [[ -n "$END_LINE" ]]; then
          echo "üîç Found options section at lines $START_LINE to $END_LINE"
          
          # Create new workflow file
          head -n $START_LINE "${{ inputs.workflow_path }}" > /tmp/workflow_temp.yml
          cat /tmp/new_options.txt >> /tmp/workflow_temp.yml
          tail -n +$((END_LINE+1)) "${{ inputs.workflow_path }}" >> /tmp/workflow_temp.yml
          
          # Replace original file
          mv /tmp/workflow_temp.yml "${{ inputs.workflow_path }}"
          echo "‚úÖ Successfully updated workflow dropdown"
        else
          echo "‚ùå Could not find options section in workflow file"
          exit 1
        fi
        
        # Cleanup
        rm -f /tmp/new_options.txt